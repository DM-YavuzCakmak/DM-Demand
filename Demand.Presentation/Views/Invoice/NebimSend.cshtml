@using Demand.Domain.NebimModels
@using System.Security.Claims
@using System.Text.Json
@model IncomingEInvoiceHeaderModel

@{
    var claimsIdentity = (ClaimsIdentity)User.Identity;
    var claims = claimsIdentity.Claims;
    var userId = long.Parse(claims.FirstOrDefault(x => x.Type == "UserId").Value);
    var isViewNewInvoice = bool.Parse(claims.FirstOrDefault(x => x.Type == "IsViewNewInvoice").Value);
    var IsViewControlInvoice = bool.Parse(claims.FirstOrDefault(x => x.Type == "IsViewControlInvoice").Value);
    var userName = claims.FirstOrDefault(x => x.Type == "FirstName")?.Value;
    var userLastName = claims.FirstOrDefault(x => x.Type == "LastName")?.Value;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link href="~/css/index.css" rel="stylesheet" asp-append-version="true" />
    <style>
        /* Kart görünümü */
        .tableBody {
            border-radius: 14px;
            padding: 28px 32px 24px;
            box-shadow: 0 12px 35px rgba(15, 23, 42, 0.12);
            border: 1px solid #e2e8f0;
        }

            /* Satırlar arası boşluk */
            .tableBody .row {
                margin-bottom: 18px;
            }

            /* Label’lar */
            .tableBody label {
                font-weight: 600;
                font-size: 0.95rem;
                color: #1f2933;
                margin-bottom: 6px;
            }

            /* Yardım yazıları */
            .tableBody small.form-text {
                font-size: 0.78rem;
                color: #6b7280;
            }

            /* Input & select’ler */
            .tableBody .form-control {
                border-radius: 10px;
                border: 1px solid #d1d5db;
                padding: 0.55rem 0.85rem;
                font-size: 0.93rem;
                transition: all 0.15s ease;
                background-color: #f9fafb;
            }

                .tableBody .form-control::placeholder {
                    color: #9ca3af;
                    font-size: 0.88rem;
                }

                .tableBody .form-control:focus {
                    background-color: #ffffff;
                    border-color: #72006F;
                    box-shadow: 0 0 0 0.17rem rgba(114, 0, 111, 0.18);
                }

            /* Zorunlu alan yıldızı */
            .tableBody label span {
                font-weight: 700;
            }

            /* Kimlik türü radio butonlarını buton gibi gösterme */
            .tableBody .btn-group .btn {
                min-width: 150px;
                border-radius: 999px !important;
                font-size: 0.9rem;
                font-weight: 500;
                padding: 0.45rem 0.9rem;
            }

            /* Birincil renk ayarları (#72006F) */
            .tableBody .btn-outline-primary {
                border-color: #72006F;
                color: #72006F;
                background-color: #fff;
            }

                .tableBody .btn-outline-primary:hover,
                .tableBody .btn-outline-primary:focus,
                .tableBody .btn-outline-primary:active,
                .tableBody .btn-outline-primary.active {
                    background-color: #72006F;
                    color: #ffffff;
                    box-shadow: 0 0 0 0.12rem rgba(114, 0, 111, 0.3);
                }

            /* Kaydet butonu */
            .tableBody .btn-primary {
                background: linear-gradient(135deg, #72006F, #a1009c);
                border: none;
                border-radius: 999px;
                padding: 0.6rem 2.4rem;
                font-weight: 600;
                letter-spacing: .02em;
                box-shadow: 0 10px 25px rgba(114, 0, 111, 0.35);
                transition: transform 0.12s ease, box-shadow 0.12s ease, filter 0.12s ease;
            }

                .tableBody .btn-primary:hover {
                    filter: brightness(1.05);
                    transform: translateY(-1px);
                    box-shadow: 0 14px 30px rgba(114, 0, 111, 0.45);
                }

                .tableBody .btn-primary:active {
                    transform: translateY(0);
                    box-shadow: 0 8px 18px rgba(114, 0, 111, 0.30);
                }

            /* Butonun bulunduğu alan */
            .tableBody .text-center {
                margin-top: 16px;
            }

        .select2-container .select2-dropdown {
            min-width: 380px !important;
        }

        .select2-results__option {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.6;
            font-size: 14px;
        }

    </style>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

    <link rel="stylesheet" href="https://use.typekit.net/ovt6ynt.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,600;0,700;0,800;1,400;1,500;1,600;1,700;1,800&family=Oswald:wght@200;300;400;500;600;700&family=Roboto+Condensed:wght@300;400;700&family=Roboto:wght@100;300;400;500;700;900&family=Source+Sans+Pro:ital,wght@0,200;0,300;0,400;0,600;0,700;0,900;1,200;1,300;1,400;1,600;1,700;1,900&family=Spectral:wght@200;300;400;500;600;700;800&display=swap" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <title>DEM MUSEUMS</title>
</head>

<body>
    <div class="header">
        <div class="logo">
            <img id="logo" src="~/images/dem_logo.png" alt="Logo">
        </div>
        <div class="user-info">
            <p>
                @{
                    string CustomName = $"{userName} {userLastName}";
                }

                @CustomName
            </p>
        </div>
    </div>

    <div class="layout">
        @Html.Partial("~/Views/Shared/_sidebar.cshtml")
        <main class="table" id="demandTable">
            <section class="table__header">
                <h1>Fatura Aktarım</h1>
            </section>

            <section class="content">
                <div id="content-2">
                    <section class="tableBody">

                        <!-- Header Bilgileri -->
                        <div class="form-row">
                            <div class="form-group">
                                <label for="company">Şirket</label>
                                <input type="text" id="company" value="@Model.CompanyName" readonly />
                            </div>
                            <div class="form-group">
                                <label for="provider">Firma</label>
                                <input type="text" id="provider" value="@Model.CurrAccDescription" readonly />
                            </div>
                            <div class="form-group">
                                <label for="taxnumber">VKN/TCKN</label>
                                <input type="text" id="taxnumber" value="@Model.TaxNumber" readonly />
                            </div>
                        </div>

                        <!-- Header Bilgileri -->
                        <div class="form-row">
                            <div class="form-group">
                                <label for="invoiceNo">Fatura No</label>
                                <input type="text" id="invoiceNo" value="@Model.EInvoiceNumber" readonly />
                            </div>
                            <div class="form-group">
                                <label for="requestDate">Fatura Tarihi</label>
                                <input type="text" id="requestDate" value="@(Model.InvoiceDate.ToString("yyyy-MM-dd"))" readonly />
                            </div>
                            <div class="form-group">
                                <label for="payableAmount">Fatura Tutarı</label>
                                <input type="text" id="payableAmount" value="@(Model.PayableAmount.ToString("N2") + " " + GetCurrencyIco(Model.DocCurrencyCode))" readonly />
                            </div>
                        </div>

                        <!-- Header Bilgileri -->
                        <div class="form-row">
                            <div class="form-group">
                                <label for="office">Ofis<span style="color: #72006F;"> *</span></label>
                                <select name="office" class="form-control" id="office">
                                    <option value="">Lütfen Seçiniz</option>
                                    @foreach (var a in ViewBag.NebimOfficeModels)
                                    {
                                        <option value="@a.OfficeCode">@a.OfficeDescription</option>
                                    }
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="warehouse">Depo<span style="color: #72006F;"> *</span></label>
                                <select name="warehouse" class="form-control" id="warehouse">
                                    <option value="">Lütfen Seçiniz</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <a href="https://portal.qnbesolutions.com.tr/efatura/display?cmd=GELEN_FATURA_GOSTER&type=html&invoiceUuid=@Model.FromIntegratorUUID"
                                   target="_blank" title="Fatura Görüntüle">
                                    <button id="invoiceDetailButton" type="button" style="margin-top:15px"><i class="fa fa-file-invoice"></i> Fatura Görüntüle</button>
                                </a>
                            </div>
                        </div>

                        <input type="hidden" id="invoiceDetailPopupInvoiceId" value="" />

                        <!-- Fatura Kalemleri -->
                        <h3 style="margin: 10px;">Fatura Kalemleri</h3>
                        <div style="max-height: 250px; overflow-y: auto; border: 1px solid #ccc;">
                            <table id="dataTableInvoiceDetail" border="1" style="width:100%; border-collapse: collapse;">
                                <thead style="position: sticky; top: 0; background-color: #f9f9f9;">
                                    <tr>
                                        <th>Adı</th>
                                        <th>Adet</th>
                                        @* <th>İndirim Oranı</th>
								<th>İndirim Tutarı</th> *@
                                        <th>KDV Oranı</th>
                                        <th>KDV Tutarı</th>
                                        <th>Toplam Tutar</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- JS ile doldurulacak -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Fatura Aktarım -->
                        <h3 style="margin: 10px;margin-top:30px">Fatura Aktarım</h3>
                        <table id="dataTable" border="1">
                            <thead style="position: sticky; top: 0; background-color: #f9f9f9;">
                                <tr>
                                    <th>Masraf<span style="color: #72006F;"> *</span></th>
                                    <th>Maliyet Merkezi<span style="color: #72006F;"> *</span></th>
                                    <th>Miktar<span style="color: #72006F;"> *</span></th>
                                    <th>Birim<span style="color: #72006F;"> *</span></th>
                                    <th>KDV<span style="color: #72006F;"> *</span></th>
                                    <th>Birim Fiyat<span style="color: #72006F;"> *</span></th>
                                    <th>İskonto Değeri<span style="color: #72006F;"> *</span></th>
                                    <th>KDV Tutarı<span style="color: #72006F;"> *</span></th>
                                    <th>Tutar<span style="color: #72006F;"> *</span></th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                        <div style="margin:20px">
                            <button id="addButton" type="button" onclick="addRow()">Satır Ekle</button>
                            <button id="removeButton" type="button" onclick="removeRow()">Satır Sil</button>
                        </div>
                        <!-- Header Bilgileri -->
                        <div class="form-row" style="margin-top:10px">
                            <div class="form-group">
                                <label for="sumTotalAmount">Toplam Tutar</label>
                                <input type="text" id="sumTotalAmount" readonly />
                            </div>
                            <div class="form-group">
                                <label for="sumDiscount">Toplam İskonto</label>
                                <input type="text" id="sumDiscount" readonly />
                            </div>
                            <div class="form-group">
                                <label for="sumSubTotal">Ara Toplam</label>
                                <input type="text" id="sumSubTotal" readonly />
                            </div>
                            <div class="form-group">
                                <label for="sumVat">KDV Tutarı</label>
                                <input type="text" id="sumVat" readonly />
                            </div>
                            <div class="form-group">
                                <label for="sumGrandTotal">KDV Dahil Toplam Tutar</label>
                                <input type="text" id="sumGrandTotal" readonly />
                            </div>
                        </div>

                        <div style="margin:20px">
                            <button id="btnInvoiceTransfer" type="button"><i class="fa fa-paper-plane"></i> Nebime Aktar</button>
                        </div>
                    </section>
                </div>
            </section>
        </main>
        <div id="overlay"></div>

        <div id="loadingOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; text-align:center; color:white; font-size:24px; line-height:100vh;">
            Yükleniyor...
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-ajax-unobtrusive/3.2.6/jquery.unobtrusive-ajax.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="~/js/script.js"></script>

</body>

</html>

<script src="//cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"> </script>
<script>
    var warehouseList = @Html.Raw(Json.Serialize(ViewBag.NebimWareHouseModels));

    $("#office").on("change", function () {
        var selectedOffice = $(this).val();
        var warehouseSelect = $("#warehouse");

        // önce depo listesini temizle
        warehouseSelect.empty();
        warehouseSelect.append('<option value="">Lütfen Seçiniz</option>');

        if (!selectedOffice) return;

        // seçilen ofise göre depoları filtrele
        var filtered = warehouseList.filter(function (w) {
            return w.officeCode == selectedOffice;
        });

        // eşleşen depoları select içine ekle
        filtered.forEach(function (w) {
            warehouseSelect.append(
                '<option value="' + w.warehouseCode + '">' + w.warehouseDescription + '</option>'
            );
        });
    });

</script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const toggles = document.querySelectorAll(".submenu-toggle");
        toggles.forEach(toggle => {
            toggle.addEventListener("click", function () {
                const submenu = this.nextElementSibling;
                submenu.classList.toggle("open");
            });
        });
        invoiceDetailPopup('@Model.InvoiceHeaderID');
    });

    function formatPrice(value) {
        if (value == null || value === "") return "";
        return Number(value).toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function formatDate(dateString) {
        if (!dateString) return "";
        const date = new Date(dateString);
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}.${month}.${year}`;
    }


    function invoiceDetailPopup(invoiceHeaderId) {
        $("#invoiceDetailPopupInvoiceId").val(invoiceHeaderId);

        $.ajax({
            url: '/Invoice/GetInvoiceDetails',
            type: 'GET',
            data: { invoiceHeaderId: invoiceHeaderId },
            success: function (data) {

                // Line bilgilerini tabloya bas
                var tableInvoiceDetail = $("#dataTableInvoiceDetail tbody");
                tableInvoiceDetail.empty();

                if (!data.invoiceDetails || data.invoiceDetails.length === 0) {
                    // ⚠️ Eğer kayıt yoksa uyarı satırı ekle
                    tableInvoiceDetail.append(`
                        <tr>
                            <td colspan="10" style="text-align:center; color:#666; padding:10px;">
                                Fatura Detayları Bulunmamaktadır
                            </td>
                        </tr>
                    `);
                } else {
                    $.each(data.invoiceDetails, function (i, line) {
                        tableInvoiceDetail.append(`
                            <tr>
                                <td data-label="Adı">${line.itemName}</td>
                                <td data-label="Adet">${line.qty1}</td>
                                <td data-label="KDV Oranı">${line.vatRate}</td>
                                <td data-label="KDV Tutarı">${line.vat}</td>
                                <td data-label="Toplam Tutar">${line.netAmount} ${line.priceCurrencyCode}</td>
                            </tr>
                        `);
                                // <td>${line.lDisRate1}</td>
                                // <td>${line.lDiscount1}</td>
                    });
                }
            }
        });
    }

</script>
<script>
    function toLowerTr(text) {
        return text
            .toLocaleLowerCase("tr")
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "");
    }

    var currentProductRow = null; // popup'u hangi satır açtı

    function addRow() {
        if (typeof rowCount === 'undefined') rowCount = 0;
        rowCount++;

        var tableBody = document.querySelector("#dataTable tbody");
        var newRow = document.createElement("tr");
        /*
          <th>Masraf</th>
          <th>Maliyet Merkezi</th>
          <th>Miktar</th>
          <th>Birim</th>
          <th>KDV</th>
          <th>Birim Fiyat</th>
          <th>Birim Fiyat(VD)</th>
          <th>İskonto</th>
          <th>İskonto Değeri</th>
          <th>Tutar</th>
        */
        var cells = ['expense', 'costcenter', 'quantity', 'unit', 'vatrate', 'unitprice', 'discount', 'vatrateamount', 'totalamount'];
        cells.forEach(function (cell) {
            var newCell = document.createElement("td");

            if (cell === 'expense' || cell === 'costcenter' || cell === 'unit' || cell === 'discounttype') {
                var div = document.createElement("div");
                div.className = "select-wrapper";
                var select = document.createElement("select");
                select.name = cell + "[]";
                select.className = cell;

                if (cell === 'unit') {
                    var option1 = document.createElement("option");
                    option1.text = "Adet";
                    option1.value = "1";
                    select.appendChild(option1);
                    var option2 = document.createElement("option");
                    option2.text = "Metre";
                    option2.value = "2";
                    select.appendChild(option2);
                } else if (cell === 'discounttype') {
                    select.innerHTML = '';
                    var defaultOption = document.createElement('option');
                    defaultOption.text = "İskonto seçiniz";
                    select.add(defaultOption);
                    var option1 = document.createElement("option");
                    option1.text = "Tutar";
                    option1.value = "1";
                    select.appendChild(option1);
                    var option2 = document.createElement("option");
                    option2.text = "Yüzde";
                    option2.value = "2";
                    select.appendChild(option2);
                    $(select).on("change", function () {
                        var $row = $(this).closest("tr");
                        // 2) discount kilidini kaldır
                        var totalAmountInput = $row.find("input.discount");
                        totalAmountInput.prop("readonly", false);
                        totalAmountInput.css("background-color", "white"); // Görsel olarak aktif olsun
                    });
                } else if (cell === 'expense') {
                    // COSTCENTER DEĞİŞTİĞİNDE SADECE O SATIRDAN totalamount READONLY KALKSIN
                    $(select).on("change", function () {

                        var selectedOption = this.options[this.selectedIndex];
                        var taxValue = selectedOption ? selectedOption.getAttribute("data-taxvalue") : "";

                        var $row = $(this).closest("tr");

                        // 1) vatrate güncelle
                        $row.find("input.vatrate").val(taxValue || "");

                        // 2) totalamount kilidini kaldır
                        var totalAmountInput = $row.find("input.totalamount");
                        totalAmountInput.prop("readonly", false);
                        totalAmountInput.css("background-color", "white"); // Görsel olarak aktif olsun

                        calculateRowPrices(this);
                        recalcTotals();
                    });
                    var expenseModels = @Html.Raw(Json.Serialize(ViewBag.NebimExpenseModels));
                    select.innerHTML = '';
                    var defaultOption = document.createElement('option');
                    defaultOption.text = "Lütfen seçiniz";
                    select.add(defaultOption);
                    expenseModels.forEach(function (expenseModel) {
                        var option = document.createElement('option');
                        option.value = expenseModel.expenseCode;
                        option.textContent = expenseModel.expenseCode + ' - ' + expenseModel.expenseDescription;

                        option.setAttribute("data-taxvalue", expenseModel.itemTaxGrCode);
                        select.appendChild(option);
                    });
                }  else if (cell === 'costcenter') {
                    var costCenterModels = @Html.Raw(Json.Serialize(ViewBag.NebimCostModels));
                    select.innerHTML = '';
                    var defaultOption = document.createElement('option');
                    defaultOption.text = "Lütfen seçiniz";
                    select.add(defaultOption);
                    costCenterModels.forEach(function (costCenterModel) {
                        var option = document.createElement('option');
                        option.value = costCenterModel.costCenterCode;
                        option.textContent = costCenterModel.costCenterDescription;
                        select.appendChild(option);
                    });
                }

                div.appendChild(select);

                setTimeout(() => {
                    $(select).select2({
                        width: "100%",
                        placeholder: "Lütfen seçiniz",
                        allowClear: true,
                        dropdownAutoWidth: true,

                    });
                }, 0);
                newCell.appendChild(div);
            } else {
                var input = document.createElement("input");
                input.type = "text";
                input.name = cell + "[]";
                input.className = cell;

                if (cell === "quantity") {
                    input.value = 1;

                    input.addEventListener("input", function () {
                        // Virgülü noktaya çevir (isteğe bağlı)
                        this.value = this.value.replace(",", ".");

                        // Sadece rakam ve tek nokta izin ver
                        this.value = this.value
                            .replace(/[^0-9.]/g, "")    // rakam ve nokta dışını sil
                            .replace(/(\..*)\./g, '$1'); // ikinci noktayı engelle

                        // Noktadan sonra max 2 basamak
                        if (this.value.includes(".")) {
                            let parts = this.value.split(".");
                            parts[1] = parts[1].slice(0, 2); // ikinci kısmı 2 basamak ile sınırla
                            this.value = parts[0] + "." + parts[1];
                        }
                    });

                    input.addEventListener("blur", function () {
                        calculateRowPrices(this);
                        recalcTotals();
                    });
                }
                if (cell === "totalamount") {

                    input.type = "text";

                    input.addEventListener("input", function () {

                        // Önce TL, nokta, boşluk gibi şeyleri temizle
                        let raw = this.value.replace(/[₺\s\.]/g, "").replace(",", ".");

                        // Geçerli sayı değilse boş bırak
                        if (isNaN(raw)) {
                            this.value = "";
                            return;
                        }

                        // Sayıya çevir
                        let num = parseFloat(raw);

                        // Eğer sayı değilse çıkar
                        if (!num && num !== 0) {
                            this.value = "";
                            return;
                        }

                        // 2 ondalık basamakla formatla
                        let formatted = num.toLocaleString("tr-TR", {
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2
                        });

                        // Noktadan sonra max 2 basamak
                        if (this.value.includes(",")) {
                            let parts = this.value.split(",");
                            parts[1] = parts[1].slice(0, 2); // ikinci kısmı 2 basamak ile sınırla
                            this.value = parts[0] + "," + parts[1];
                        }

                    });

                    // Input odaktan çıkınca format tekrar uygulanır
                    input.addEventListener("blur", function () {
                        let raw = this.value.replace(/[₺\s\.]/g, "").replace(",", ".");
                        let num = parseFloat(raw);

                        if (!isNaN(num)) {
                            this.value = num.toLocaleString("tr-TR", {
                                minimumFractionDigits: 2,
                                maximumFractionDigits: 2
                            }) + " ₺";
                        }
                        calculateRowPrices(this);
                        recalcTotals();

                    });
                }
                if (cell === "discount") {

                    input.type = "text";
                    input.value = '0,00 ₺';
                    input.addEventListener("input", function () {

                        // Önce TL, nokta, boşluk gibi şeyleri temizle
                        let raw = this.value.replace(/[₺\s\.]/g, "").replace(",", ".");

                        // Geçerli sayı değilse boş bırak
                        if (isNaN(raw)) {
                            this.value = "";
                            return;
                        }

                        // Sayıya çevir
                        let num = parseFloat(raw);

                        // Eğer sayı değilse çıkar
                        if (!num && num !== 0) {
                            this.value = "";
                            return;
                        }

                        // 2 ondalık basamakla formatla
                        let formatted = num.toLocaleString("tr-TR", {
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2
                        });

                        // Noktadan sonra max 2 basamak
                        if (this.value.includes(",")) {
                            let parts = this.value.split(",");
                            parts[1] = parts[1].slice(0, 2); // ikinci kısmı 2 basamak ile sınırla
                            this.value = parts[0] + "," + parts[1];
                        }

                    });

                    // Input odaktan çıkınca format tekrar uygulanır
                    input.addEventListener("blur", function () {
                        let raw = this.value.replace(/[₺\s\.]/g, "").replace(",", ".");
                        let num = parseFloat(raw);

                        if (!isNaN(num)) {
                            this.value = num.toLocaleString("tr-TR", {
                                minimumFractionDigits: 2,
                                maximumFractionDigits: 2
                            }) + " ₺";
                        }
                        calculateRowPrices(this);
                        recalcTotals();
                    });
                }

                // READONLY OLACAK ALANLAR
                var readonlyCells = ["vatrate", "unitprice", "vatrateamount"];
                if (readonlyCells.includes(cell)) {
                    input.readOnly = true;
                    input.style.backgroundColor = "#f2f2f2";  // İstersen gri yap
                }
                if (cell === "quantity") {
                    input.value = 1;
                }
                newCell.className = "form-group";
                newCell.appendChild(input);
            }

            newRow.appendChild(newCell);
        });

        tableBody.appendChild(newRow);
    }

    function parseTL(value) {
        if (!value) return 0;

        return parseFloat(
            value.toString()
                .replace(/[₺\s]/g, "")  // TL ve boşlukları sil
                .replace(/\./g, "")     // binlik nokta
                .replace(",", ".")      // ondalık virgül → nokta
        ) || 0;
    }

    function formatTL(num) {
        return num.toLocaleString("tr-TR", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }) + " ₺";
    }

    // sadece sayısal alanlar için (miktar vb.)
    function parseNumber(value) {
        if (!value) return 0;
        return parseFloat(
            value.toString()
                .replace(/\./g, "")
                .replace(",", ".")
        ) || 0;
    }

    function recalcTotals() {
        var totalAmountSum = 0;  // Tutar kolonları toplamı
        var discountSum    = 0;  // İskonto Değeri kolonları toplamı
        var vatSum         = 0;  // Toplam KDV
        // Ara Toplam = toplamTutar - toplamİskonto
        // KDV Dahil Toplam = AraToplam + KDV

        $('#dataTable tbody tr').each(function () {
            var $row = $(this);

            var rowTotal     = parseTL($row.find('input.totalamount').val());
            var rowDiscount  = parseTL($row.find('input.discount').val());

            totalAmountSum += rowTotal;
            discountSum    += rowDiscount;

            // İskonto düşülmüş baz tutar
            var baseAmount = Math.max(rowTotal - rowDiscount, 0);

            // KDV oranı: "%1", "%10", "%1-%10" gibi değerlerden ilkini al
            var kdvText  = ($row.find('input.vatrate').val() || "").trim(); // ör: "%1-%10"
            var kdvFirst = kdvText.split('-')[0].trim();                    // "%1"
            var kdvNum   = parseFloat(
                kdvFirst.replace('%', '').replace(',', '.')
            ) || 0;                                                         // 1

            var kdvRate = kdvNum / 100.0;                                   // 0.01

            // Satır KDV: iskonto düşülmüş tutar × oran
            var rowVat = baseAmount * kdvRate;
            vatSum += rowVat;
        });

        var subTotal   = totalAmountSum - discountSum;
        var grandTotal = subTotal + vatSum;

        $('#sumTotalAmount').val(formatTL(totalAmountSum));
        $('#sumDiscount').val(formatTL(discountSum));
        $('#sumSubTotal').val(formatTL(subTotal));
        $('#sumVat').val(formatTL(vatSum));
        $('#sumGrandTotal').val(formatTL(grandTotal));
    }

    function calculateRowPrices(totalAmountInput) {

        var $row = $(totalAmountInput).closest("tr");

        // Miktar
        var quantity = parseFloat(
            $row.find("input.quantity").val().replace(",", ".")
        );
        if (!quantity || quantity <= 0) return;

        // Toplam tutarı numerik hale getir
        var totalRaw = $row.find("input.totalamount").val()
            .replace(/[₺\s\.]/g, "") // . ve TL işaretlerini sil
            .replace(",", ".");

        var total = parseFloat(totalRaw) || 0;

        var discountRaw = ($row.find("input.discount").val() || "")
            .replace(/[₺\s\.]/g, "")
            .replace(",", ".");
        var discount = parseFloat(discountRaw) || 0;

        // İskonto düşülmüş tutar (KDV bu tutar üzerinden hesaplanacak)
        var baseAmount = Math.max(total - discount, 0);

        // KDV oranı (%10 → 10)
        var kdvText = ($row.find("input.vatrate").val() || "").trim();
        var kdvFirst = kdvText.split('-')[0].trim();                // "%1-%10" → "%1"
        var kdvRaw = kdvFirst.replace("%", "").replace(",", ".");   // "%1" → "1"
        var kdvRate = (parseFloat(kdvRaw) || 0) / 100;              // 1 → 0.01

        // 1) KDV’siz birim fiyat (toplam / miktar)
        var unitPrice = quantity > 0 ? (total / quantity) : 0;

        // 2) Satır KDV tutarı = (iskonto düşülmüş tutar × oran)
        var rowVat = baseAmount * kdvRate;

        // formatlı yaz
        var formatTL = (n) =>
            n.toLocaleString("tr-TR", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " ₺";

        $row.find("input.unitprice").val(formatTL(unitPrice));
        $row.find("input.vatrateamount").val(formatTL(rowVat));
    }

    function validateForm() {
        let demandTitle = $("#demandTitle").val().trim();
        let description = $("#description").val().trim();
        let rowCount = $("#yourTableId tbody tr").length;

        if (demandTitle === "") {
            toastr.error("Talep başlığı girilmesi zorunludur.", "Hata");
            return false;
        }

        if (description === "") {
            toastr.error("Açıklama alanı girilmesi zorunludur.", "Hata");
            return false;
        }

        return true;
    }

    function removeRow() {
        var table = document.getElementById("dataTable");
        if (table.rows.length > 1) {
            table.deleteRow(-1);
        }
        recalcTotals();
    }
</script>
<script>
    $('#btnInvoiceTransfer').on('click', function (e) {
        var errors = [];

        // 1) Ofis seçilmiş mi?
        var officeVal = $('#office').val();
        if (!officeVal || officeVal === "" || officeVal === "Lütfen Seçiniz") {
            errors.push("Lütfen bir ofis seçiniz.");
        }

        // 2) Depo seçilmiş mi?
        var warehouseVal = $('#warehouse').val();
        if (!warehouseVal || warehouseVal === "" || warehouseVal === "Lütfen Seçiniz") {
            errors.push("Lütfen bir depo seçiniz.");
        }

        // 3) Tabloda satır var mı?
        var rows = $('#dataTable tbody tr');
        if (rows.length === 0) {
            errors.push("Lütfen en az bir satır ekleyiniz.");
        }

        // 4) Tüm satırların tutarı 0'dan büyük olmalı
        var allRowsValid = true;

        rows.each(function () {
            var totalVal = parseTL($(this).find('input.totalamount').val());
            if (totalVal <= 0) {
                allRowsValid = false;
                return false; // break
            }
        });

        if (!allRowsValid) {
            errors.push("Tüm satırlarda 'Tutar' değeri 0'dan büyük olmalıdır.");
        }

        // Validasyon hatası varsa işlemi durdur
        if (errors.length > 0) {
            e.preventDefault();
            toastr.error(errors.join("\n"), "Hata");
            return false;
        }

        // Her şey doğru → işlem devam
        toastr.success(`Fatura Nebime Aktarılmıştır.`, "Başarılı");
    });
</script>
@functions {
    string GetInvoiceType(int type)
    {
        switch (type)
        {
            case 0: return "Toptan Alım";
            case 1: return "Konsiye Alım";
            case 2: return "Masraf Alım";
            default: return type.ToString();
        }
    }

    string GetCurrencyIco(string currencyCode)
    {
        switch (currencyCode)
        {
            case "TRY": return "₺";
            case "USD": return "$";
            case "EUR": return "€";
            case "GBP": return "£";
            default: return currencyCode;
        }
    }
}