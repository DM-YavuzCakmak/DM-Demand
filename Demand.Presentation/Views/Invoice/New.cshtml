@using Demand.Domain.NebimModels
@using System.Security.Claims
@using System.Text.Json
@model List<IncomingEInvoiceHeaderModel>

@{
    var claimsIdentity = (ClaimsIdentity)User.Identity;
    var claims = claimsIdentity.Claims;
    var userId = long.Parse(claims.FirstOrDefault(x => x.Type == "UserId").Value);
    var isViewNewInvoice = bool.Parse(claims.FirstOrDefault(x => x.Type == "IsViewNewInvoice").Value);
    var IsViewControlInvoice = bool.Parse(claims.FirstOrDefault(x => x.Type == "IsViewControlInvoice").Value);
    var userName = claims.FirstOrDefault(x => x.Type == "FirstName")?.Value;
    var userLastName = claims.FirstOrDefault(x => x.Type == "LastName")?.Value;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link href="~/css/index.css" rel="stylesheet" asp-append-version="true" />
    <style>
        .matched-row {
            background-color: #c9f7c1 !important; /* açık mavi ton */
            transition: background-color 0.3s ease !important;
        }

            .matched-row:hover {
                background-color: #b3f0aa !important; /* hover olduğunda biraz daha koyu */
            }

        .filter-bar {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

            .filter-bar input {
                padding: 6px 10px;
                border: 1px solid #ccc;
                border-radius: 6px;
            }

            .filter-bar button {
                padding: 6px 14px;
                border: none;
                border-radius: 6px;
                background: #444;
                color: white;
                cursor: pointer;
            }
    </style>
    <link rel="stylesheet" href="https://use.typekit.net/ovt6ynt.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,600;0,700;0,800;1,400;1,500;1,600;1,700;1,800&family=Oswald:wght@200;300;400;500;600;700&family=Roboto+Condensed:wght@300;400;700&family=Roboto:wght@100;300;400;500;700;900&family=Source+Sans+Pro:ital,wght@0,200;0,300;0,400;0,600;0,700;0,900;1,200;1,300;1,400;1,600;1,700;1,900&family=Spectral:wght@200;300;400;500;600;700;800&display=swap" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <title>DEM MUSEUMS</title>
</head>

<body>
    <div class="header">
        <div class="logo">
            <img id="logo" src="~/images/dem_logo.png" alt="Logo">
        </div>
        <div class="user-info">
            <p>
                @{
                    string CustomName = $"{userName} {userLastName}";
                }

                @CustomName
            </p>
        </div>
    </div>

    <div class="layout">
        <div id="hamburger">&#9776;</div>
        <div id="overlay"></div>
        <nav class="sidebar" id="sidebar">
            <ul>
                <li><a href="@Url.Action("Index", "Home")" class="@(ViewData["ActivePage"] as string == "Home" ? "active" : "")">Talep Listesi</a></li>
                <li>
                    <a href="javascript:void(0)" class="submenu-toggle">Fatura Listesi ▾</a>
                    <ul class="submenu @( (ViewData["ActivePage"] as string)?.StartsWith("Invoice") == true ? "open" : "" )">
                        @if (isViewNewInvoice)
                        {
                            <li>
                                <a href="@Url.Action("New", "Invoice")" class="@(ViewData["ActivePage"] as string == "InvoiceNew" ? "active" : "")">
                                    Yeni
                                </a>
                            </li>
                        }
                        @if (IsViewControlInvoice)
                        {
                            <li>
                                <a href="@Url.Action("Control", "Invoice")" class="@(ViewData["ActivePage"] as string == "InvoiceControl" ? "active" : "")">
                                    Kontrol Bekleyen
                                </a>
                            </li>
                        }
                        <li>
                            <a href="@Url.Action("Pending", "Invoice")" class="@(ViewData["ActivePage"] as string == "InvoicePending" ? "active" : "")">
                                Onay Bekleyen
                            </a>
                        </li>
                        <li>
                            <a href="@Url.Action("Approved", "Invoice")" class="@(ViewData["ActivePage"] as string == "InvoiceApproved" ? "active" : "")">
                                Onaylanan
                            </a>
                        </li>
                        <li>
                            <a href="@Url.Action("Reject", "Invoice")" class="@(ViewData["ActivePage"] as string == "InvoiceReject" ? "active" : "")">
                                Reddedilen
                            </a>
                        </li>
                    </ul>
                </li>
                <li>
                    <a href="javascript:void(0)" class="submenu-toggle">Tedarikçi Listesi ▾</a>
                    <ul class="submenu @( (ViewData["ActivePage"] as string)?.StartsWith("Provider") == true ? "open" : "" )">
                        <li>
                            <a href="@Url.Action("New", "Provider")" class="@(ViewData["ActivePage"] as string == "ProviderNew" ? "active" : "")">
                                Yeni Başvuru
                            </a>
                        </li>
                        <li>
                            <a href="@Url.Action("Approved", "Provider")" class="@(ViewData["ActivePage"] as string == "ProviderApproved" ? "active" : "")">
                                Onaylı Tedarikçi Listesi
                            </a>
                        </li>
                        <li>
                            <a href="@Url.Action("Pending", "Provider")" class="@(ViewData["ActivePage"] as string == "ProviderPending" ? "active" : "")">
                                Onay Bekleyenler
                            </a>
                        </li>
                    </ul>
                </li>

            </ul>
        </nav>
        <main class="table" id="demandTable">
            <section class="table__header">
                <h1>Fatura Listesi - Yeni</h1>

                <div class="filter-bar">
                    <input type="text" id="filterInvoiceNo" placeholder="Fatura No" />
                    <input type="text" id="filterSupplier" placeholder="Tedarikçi / Firma" />
                    <input type="text" id="filterVkn" placeholder="VKN / TCKN" />

                    <button onclick="clearFilters()">Temizle</button>
                    <button type="button"
                            class="excel-btn"
                            onclick="exportTableToExcel()">
                        <i class="fa fa-file-excel"></i> Excel’e Aktar
                    </button>

                </div>
            </section>

            <section class="content">
                <div id="content-0">
                    <section class="tableBody">
                        <table>
                            <thead>
                                <tr>
                                    <th> Şirket <span class="icon-arrow">&UpArrow;</span></th>
                                    <th> Fatura No <span class="icon-arrow">&UpArrow;</span></th>
                                    <th> Firma <span class="icon-arrow">&UpArrow;</span></th>
                                    <th> VKN/TCKN <span class="icon-arrow">&UpArrow;</span></th>
                                    <th> Fatura Tipi <span class="icon-arrow">&UpArrow;</span></th>
                                    <th> Fatura Tarihi <span class="icon-arrow">&UpArrow;</span></th>
                                    <th> Fatura Tutarı <span class="icon-arrow">&UpArrow;</span></th>
                                    <th> Aksiyon <span class="icon-arrow">&UpArrow;</span></th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var invoice in Model.Where(x => x.InvoiceDetailEntity == null))
                                {
                                    <tr>
                                        <td data-label="Şirket">@invoice.CompanyName</td>
                                        <td data-label="Fatura No">@invoice.EInvoiceNumber</td>
                                        <td data-label="Firma">@invoice.CurrAccDescription</td>
                                        <td data-label="VKN/TCKN">@(string.IsNullOrWhiteSpace(invoice.TaxNumber) ? invoice.IdentityNum : invoice.TaxNumber)</td>
                                        <td class="action-buttons">
                                            <a href="javascript:void(0)" class="update-button" style="padding:2px 6px !important" onclick="invoiceTypeUpdatePopUp('@invoice.InvoiceHeaderID')" title="Fatura Tipi Güncelle">
                                                <i class="fa fa-edit"></i>
                                            </a>
                                        </td>
                                        <td data-label="Fatura Tarihi">@(invoice.InvoiceDate.ToString("yyyy-MM-dd"))</td>
                                        <td data-label="Fatura Tutarı">@(invoice.PayableAmount.ToString("N2") + " " + GetCurrencyIco(invoice.DocCurrencyCode))</td>
                                        <td class="action-buttons">
                                            <a href="https://portal.qnbesolutions.com.tr/efatura/display?cmd=GELEN_FATURA_GOSTER&type=html&invoiceUuid=@invoice.FromIntegratorUUID"
                                               target="_blank" title="Fatura Detayı">
                                                <i class="fa fa-file-invoice"></i>
                                            </a>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </section>
                </div>
            </section>

        </main>
        <div id="overlay"></div>

        <div id="invoiceTypePopup" class="popup">
            <div class="popup-header">
                <h2>Fatura Tipi Güncelle</h2>
            </div>

            <div class="popup-content">

                <!-- Header Bilgileri -->
                <div class="form-row">
                    <div class="form-group" style="width:auto !important">
                        <label for="invoiceType">Fatura Tipi:</label>
                        <select id="invoiceType" name="invoiceType">
                            <option value="Please Select Invoice Type">Lütfen fatura tipi seçin...</option>
                            <option value="0">Toptan Alım</option>
                            <option value="1">Konsiye Alım</option>
                            <option value="2">Masraf Alımı</option>
                        </select>
                    </div>

                    <div class="form-group" style="width:auto !important">
                        <label for="responsiblePersonId">Yönlendir:</label>
                        <select id="responsiblePersonId" name="responsiblePersonId">
                            <option value="Please Select Responsible Person">Lütfen kullanıcı seçin...</option>
                            @foreach (var personnel in ViewBag.PersonnelList)
                            {
                                @if (personnel.Id == userId)
                                {
                                    <option value="@personnel.Id" selected>@(personnel.FirstName + " " + personnel.LastName)</option>
                                }
                                else if (personnel.IsViewNewInvoice == true)
                                {
                                    <option value="@personnel.Id">@(personnel.FirstName + " " + personnel.LastName)</option>
                                }
                            }
                        </select>
                    </div>
                    <input type="hidden" id="invoiceTypePopupInvoiceId" value="" />
                    <div class="form-group" style="width:auto !important">
                        <a href="javascript:void(0)" class="update-button" onclick="invoiceUpdate()">Güncelle</a>

                    </div>
                </div>

            </div>
        </div>
        <div id="loadingOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; text-align:center; color:white; font-size:24px; line-height:100vh;">
            Yükleniyor...
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-ajax-unobtrusive/3.2.6/jquery.unobtrusive-ajax.min.js"></script>
    <script src="~/js/script.js"></script>

    <script>
         const hamburger = document.getElementById('hamburger');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');

        // Menü aç/kapa
        hamburger.addEventListener('click', () => {
            sidebar.classList.toggle('active');
            overlay.style.display = sidebar.classList.contains('active') ? 'block' : 'none';
        });

        // Overlay'e tıklayınca menüyü kapat
        overlay.addEventListener('click', () => {
            sidebar.classList.remove('active');
            overlay.style.display = 'none';
        });
    </script>
</body>

</html>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
    function exportTableToExcel() {
        const table = document.querySelector("#demandTable table");
        if (!table) return;

        // Sadece görünen satırları export etmek için geçici bir tablo kopyası oluşturuyoruz
        const clonedTable = table.cloneNode(true);

        // Aksiyon kolonu (son kolon) export edilmesin istersen kaldır
        // (İstersen bu kısmı yorum satırı yapabilirsin)
        const headerRow = clonedTable.querySelector("thead tr");
        if (headerRow && headerRow.lastElementChild) headerRow.lastElementChild.remove();

        // Filtre sonrası gizlenen satırları kaldır
        const bodyRows = Array.from(clonedTable.querySelectorAll("tbody tr"));
        bodyRows.forEach(r => {
            // Orijinal tablodaki karşılığının display durumuna bak
            const index = bodyRows.indexOf(r);
            const originalRow = table.querySelectorAll("tbody tr")[index];
            const isHidden = originalRow && window.getComputedStyle(originalRow).display === "none";

            // Aksiyon kolonu kaldır
            if (r.lastElementChild) r.lastElementChild.remove();

            if (isHidden) r.remove();
        });

        // Excel'e çevir
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.table_to_sheet(clonedTable);
        XLSX.utils.book_append_sheet(wb, ws, "YeniFaturalar");

        const fileName = `Yeni_Faturalar_${new Date().toISOString().slice(0,10)}.xlsx`;
        XLSX.writeFile(wb, fileName);
    }
</script>
<script src="//cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"> </script>
<script>
    const invoiceInput = document.getElementById("filterInvoiceNo");
    const supplierInput = document.getElementById("filterSupplier");
    const vknInput = document.getElementById("filterVkn");

    const rows = document.querySelectorAll("tbody tr");

    function filterTable() {
        const invoiceVal = invoiceInput.value.toLowerCase();
        const supplierVal = supplierInput.value.toLowerCase();
        const vknVal = vknInput.value.toLowerCase();

        rows.forEach(row => {
            const invoiceNo = row.children[1].innerText.toLowerCase();
            const supplier = row.children[2].innerText.toLowerCase();
            const vkn = row.children[3].innerText.toLowerCase();

            const visible =
                invoiceNo.includes(invoiceVal) &&
                supplier.includes(supplierVal) &&
                vkn.includes(vknVal);

            row.style.display = visible ? "" : "none";
        });
    }

    invoiceInput.addEventListener("keyup", filterTable);
    supplierInput.addEventListener("keyup", filterTable);
    vknInput.addEventListener("keyup", filterTable);

    function clearFilters() {
        invoiceInput.value = "";
        supplierInput.value = "";
        vknInput.value = "";
        filterTable();
    }
</script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const toggles = document.querySelectorAll(".submenu-toggle");
        toggles.forEach(toggle => {
            toggle.addEventListener("click", function () {
                const submenu = this.nextElementSibling;
                submenu.classList.toggle("open");
            });
        });
    });

    function formatPrice(value) {
        if (value == null || value === "") return "";
        return Number(value).toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function formatDate(dateString) {
        if (!dateString) return "";
        const date = new Date(dateString);
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}.${month}.${year}`;
    }

    document.addEventListener('keydown', function (event) {
        if (event.key === 'Escape') {
            closePopup("invoiceDetailPopup");
            closePopup("invoiceTypePopup");
            closePopup("invoiceApprovedUpdatePopup");
            closePopup("invoiceRejectionPopup");
        }
    });

    function invoiceTypeUpdatePopUp(invoiceHeaderId){
        openPopup("invoiceTypePopup");

        $("#invoiceTypePopupInvoiceId").val(invoiceHeaderId);
    }

    function invoiceApprovedUpdatePopUp(invoiceHeaderId){
        openPopup("invoiceApprovedUpdatePopup");

        $("#invoiceApprovedUpdatePopupInvoiceId").val(invoiceHeaderId);
    }

    function invoiceRejection2(){
        closePopup("invoiceDetailPopup");

        var invoiceId = $("#invoiceDetailPopupInvoiceId").val();
        invoiceRejectionPopUp(invoiceId);
    }

    function invoiceRejectionPopUp(invoiceHeaderId){
        openPopup("invoiceRejectionPopup");

        $("#invoiceRejectionPopupInvoiceId").val(invoiceHeaderId);
    }

     function invoiceUpdate() {
        var invoiceId = $("#invoiceTypePopupInvoiceId").val();
        var invoiceType = $("#invoiceType").val();
        var responsiblePersonId = $("#responsiblePersonId").val();

        var data = {
            id: invoiceId,
            invoiceType: parseInt(invoiceType),
            responsiblePersonId: parseInt(responsiblePersonId)
        };

        $.ajax({
            url: '/Invoice/InvoiceUpdate',
            type: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function (response) {
                toastr.success(`Fatura Bilgileri Güncellenmiştir.`, "Başarılı");
                location.reload();
            },
            error: function (xhr, status, error) {
                toastr.error(`Bir hata oluştu, lütfen tekrar deneyin.`, "Hata");
            }
        });
    }

     function invoiceApprovedUpdate() {
        var invoiceId = $("#invoiceApprovedUpdatePopupInvoiceId").val();
        var approvedPersonId = $("#approvedPersonId").val();

        var data = {
            id: invoiceId,
            approvedPersonId: parseInt(approvedPersonId)
        };

        $.ajax({
            url: '/Invoice/InvoiceApprovedUpdate',
            type: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function (response) {
                toastr.success(`Fatura Onaya Gönderilmiştir.`, "Başarılı");
                location.reload();
            },
            error: function (xhr, status, error) {
                toastr.error(`Bir hata oluştu, lütfen tekrar deneyin.`, "Hata");
            }
        });
    }

     function invoiceRejection() {
        Swal.fire({
            title: "Emin misiniz?",
            text: "Bu faturayı onaylamak istediğinize emin misiniz?",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Evet, onayla",
            cancelButtonText: "Vazgeç",
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#d33"
        }).then((result) => {
            if (result.isConfirmed) {
                var invoiceId = $("#invoiceRejectionPopupInvoiceId").val();
                var rejectionDesc = $("#rejectionDesc").val();

                var data = {
                    id: invoiceId,
                    rejectionDesc: rejectionDesc
                };

                $.ajax({
                    url: '/Invoice/InvoiceRejection',
                    type: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify(data),
                    success: function (response) {
                        toastr.success(`Fatura Ret Edilmiştir.`, "Başarılı");
                        location.reload();
                    },
                    error: function (xhr, status, error) {
                        toastr.error(`Bir hata oluştu, lütfen tekrar deneyin.`, "Hata");
                    }
                });
            }
        });
    }

    function invoiceApproved2(){
        closePopup("invoiceDetailPopup");

        var invoiceId = $("#invoiceDetailPopupInvoiceId").val();
        invoiceApproved(invoiceId);
    }

    function invoiceApproved(invoiceHeaderId) {
        Swal.fire({
            title: "Emin misiniz?",
            text: "Bu faturayı onaylamak istediğinize emin misiniz?",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Evet, onayla",
            cancelButtonText: "Vazgeç",
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#d33"
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: '/Invoice/InvoiceApproved',
                    type: 'GET',
                    data: { invoiceHeaderId: invoiceHeaderId },
                    success: function (response) {
                        toastr.success(`Fatura Onaylanmıştır.`, "Başarılı");
                        location.reload();
                    },
                    error: function (xhr, status, error) {
                        toastr.error(`Bir hata oluştu, lütfen tekrar deneyin.`, "Hata");
                    }
                });
            }
        });
    }

    $(document).on('change', '.chk-select', function () {
        var row = $(this).closest('tr');
        if ($(this).is(':checked')) {
            row.addClass('matched-row');
        } else {
            row.removeClass('matched-row');
        }
    });

    function invoiceDetailPopup(invoiceHeaderId) {
        $("#invoiceDetailPopupInvoiceId").val(invoiceHeaderId);

        $.ajax({
            url: '/Invoice/GetInvoiceDemands',
            type: 'GET',
            data: { invoiceHeaderId: invoiceHeaderId },
            success: function (data) {
                // Header bilgilerini doldur
                $("#invoiceNo").val(data.invoice.eInvoiceNumber);
                $("#requestDate").val(formatDate(data.invoice.invoiceDate));
                // $("#description").val(data.invoice.description);
                $("#payableAmount").val(formatPrice(data.invoice.payableAmount) + " " + data.invoice.docCurrencyCode);

                $("#company").val(data.invoice.companyName);
                $("#provider").val(data.invoice.currAccDescription);
                $("#taxnumber").val(data.invoice.taxNumber);// IdentityNum

                // Line bilgilerini tabloya bas
                var tableInvoiceDetail = $("#dataTableInvoiceDetail tbody");
                tableInvoiceDetail.empty();

                if (!data.invoiceDetails || data.invoiceDetails.length === 0) {
                    // ⚠️ Eğer kayıt yoksa uyarı satırı ekle
                    tableInvoiceDetail.append(`
                        <tr>
                            <td colspan="10" style="text-align:center; color:#666; padding:10px;">
                                Fatura Detayları Bulunmamaktadır
                            </td>
                        </tr>
                    `);
                } else {
                    $.each(data.invoiceDetails, function (i, line) {
                        tableInvoiceDetail.append(`
                            <tr>
                                <td data-label="Adı">${line.itemName}</td>
                                <td data-label="Adet">${line.qty1}</td>
                                <td data-label="KDV Oranı">${line.vatRate}</td>
                                <td data-label="KDV Tutarı">${line.vat}</td>
                                <td data-label="Toplam Tutar">${line.netAmount} ${line.priceCurrencyCode}</td>
                            </tr>
                        `);
                                // <td>${line.lDisRate1}</td>
                                // <td>${line.lDiscount1}</td>
                    });
                }

                // Line bilgilerini tabloya bas
                var table = $("#dataTable tbody");
                table.empty();

                if (!data.demands || data.demands.length === 0) {
                    // ⚠️ Eğer kayıt yoksa uyarı satırı ekle
                    table.append(`
                        <tr>
                            <td colspan="10" style="text-align:center; color:#666; padding:10px;">
                                VKN/TCKN ait Satın Alma Talebi Bulunamamıştır.
                            </td>
                        </tr>
                    `);

                    const div = document.getElementById("saveInvoiceDemand");
                    div.style.display = "none";
                } else {
                    const div = document.getElementById("saveInvoiceDemand");
                    div.style.display = "block";

                    $.each(data.demands, function (i, line) {
                        // matchingPrice dolu mu kontrol et
                        var isMatched = line.matchingPrice != null && line.matchingPrice !== "";
                        var checkboxChecked = isMatched ? "checked" : "";
                        var inputValue = isMatched ? line.matchingPrice : line.totalPrice;
                        var rowClass = isMatched ? "matched-row" : "";

                        table.append(`
                            <tr class="${rowClass}"
                                data-total="${line.remainingPrice}"
                                data-id="${line.demandId}"
                                data-invoicetotal="${data.invoice.payableAmount}"
                                data-currency="${line.currencySymbol}">

                                <td data-label="Seç">
                                    <input type="checkbox" class="chk-select" ${checkboxChecked} />
                                </td>
                                <td data-label="Id">${line.demandId}</td>
                                <td data-label="Başlık">${line.demandTitle}</td>
                                <td data-label="Departman">${line.departmentName}</td>
                                <td data-label="Kur">${formatPrice(line.exchangeRate)}</td>
                                <td data-label="Toplam Tutar">${formatPrice(line.totalPrice)} ${line.currencySymbol}</td>
                                <td data-label="Kalan Tutar">${formatPrice(line.remainingPrice)} ${line.currencySymbol}</td>
                                <td data-label="Tutar Giriş">
                                    <input type="number"
                                           class="txt-tutar"
                                           min="0"
                                           max="${line.totalPrice}"
                                           value="${inputValue}"
                                           step="0.01"
                                           style="width:80px;" />${line.currencySymbol}
                                </td>
                                <td data-label="Aksiyon">
                                    <a target="_blank"
                                       href="../api/Demands/DemandOfferDetail?DemandId=${line.demandId}"
                                       style="text-align: center;display: inline-block;font-weight: bold;">
                                       Teklif Detayı
                                    </a>
                                </td>
                            </tr>
                        `);
                    });
                }

                // Popup aç
                openPopup("invoiceDetailPopup");
            }
        });
    }

        // Eşle butonuna tıklanınca
    function SaveInvoceDemand() {
        var selectedItems = [];
        var hasError = false; // ⚠️ Hata durumunu takip edecek bayrak
        var invoiceId = $("#invoiceDetailPopupInvoiceId").val();
        var selectedInvoiceTotal = 0;

        $("#dataTable tbody tr").each(function () {
            debugger;
            var checkbox = $(this).find(".chk-select");
            if (checkbox.is(":checked")) {
                var demandId = $(this).data("id");
                var currencySymbol = $(this).data("currency");
                var total = parseFloat($(this).data("total"));
                var invoiceTotal = parseFloat($(this).data("invoicetotal"));
                var tutar = parseFloat($(this).find(".txt-tutar").val());

                if (isNaN(tutar) || tutar <= 0) {
                    toastr.error(`Lütfen geçerli bir tutar giriniz.`, "Hata");
                    hasError = true;
                    return false;
                }

                if (tutar > total) {
                    toastr.error(`Girilen tutar (${formatPrice(tutar)} ${currencySymbol}), satırın kalan tutarını (${formatPrice(total)} ${currencySymbol}) aşamaz!`, "Hata");
                    hasError = true;
                    return false;
                }

                selectedInvoiceTotal += tutar;
                if (selectedInvoiceTotal > invoiceTotal) {
                    toastr.error(`Girilen tutarların toplamı (${formatPrice(selectedInvoiceTotal)} ${currencySymbol}), fatura tutarını (${formatPrice(invoiceTotal)} ${currencySymbol}) aşamaz!`, "Hata");
                    hasError = true;
                    return false;
                }

                selectedItems.push({
                    invoiceId: invoiceId,
                    demandId: demandId,
                    amount: tutar
                });
            }
        });
        debugger;

        if (hasError) {
            return; // ❌ Hata varsa işlem tamamen durur
        }

        if (selectedItems.length === 0) {
            toastr.error(`Lütfen en az bir satır seçin.`, "Hata");
            return;
        }

        // AJAX POST isteği
        $.ajax({
            url: '/Invoice/SaveInvoiceDemand',
            type: 'PUT',
            data: JSON.stringify(selectedItems),
            contentType: 'application/json',
            success: function (res) {
                toastr.success(`Eşleştirme işlemi başarılı!`, "Başarılı");
                closePopup("invoiceDetailPopup");
            },
            error: function (err) {
                console.error(err);
                toastr.error(`Bir hata oluştu, lütfen tekrar deneyin.`, "Hata");
            }
        });
    }



    function openPopup(popupId) {
        var overlay = document.getElementById("overlay");
        var popup = document.getElementById(popupId);

        if (overlay && popup) {
            overlay.style.display = "block";
            popup.style.display = "block";

            popup.style.width = "80%";
            popup.style.height = "90%";

            overlay.addEventListener("click", function () {
                closePopup(popupId);
            });
        }
    }

    function closePopup(popupId) {
        var overlay = document.getElementById("overlay");
        var popup = document.getElementById(popupId);

        if (overlay && popup) {
            overlay.style.display = "none";
            popup.style.display = "none";
            overlay.removeEventListener("click", function () {
                closePopup(popupId);
            });
        }
    }
</script>

@functions {
    string GetInvoiceType(int type)
    {
        switch (type)
        {
            case 0: return "Toptan Alım";
            case 1: return "Konsiye Alım";
            case 2: return "Masraf Alım";
            default: return type.ToString();
        }
    }

    string GetStatusClass(int status)
    {
        switch (status)
        {
            case -1: return "new";
            case 0: return "pending";
            case 1: return "cancelled";
            case 2: return "approved";
            default: return "";
        }
    }

    string GetStatusText(int status)
    {
        switch (status)
        {
            case -1: return "Yeni";
            case 0: return "Beklemede";
            case 1: return "Reddedildi";
            case 2: return "Onaylandı";
            default: return "";
        }
    }

    string GetCurrencyIco(string currencyCode)
    {
        switch (currencyCode)
        {
            case "TRY": return "₺";
            case "USD": return "$";
            case "EUR": return "€";
            case "GBP": return "£";
            default: return currencyCode;
        }
    }
}