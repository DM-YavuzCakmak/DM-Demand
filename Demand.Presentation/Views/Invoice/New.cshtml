@using Demand.Domain.NebimModels
@using System.Security.Claims
@using System.Text.Json
@model List<IncomingEInvoiceHeaderModel>

@{
    var claimsIdentity = (ClaimsIdentity)User.Identity;
    var claims = claimsIdentity.Claims;
    var userId = long.Parse(claims.FirstOrDefault(x => x.Type == "UserId").Value);
    var isViewNewInvoice = bool.Parse(claims.FirstOrDefault(x => x.Type == "IsViewNewInvoice").Value);
    var IsViewControlInvoice = bool.Parse(claims.FirstOrDefault(x => x.Type == "IsViewControlInvoice").Value);
    var userName = claims.FirstOrDefault(x => x.Type == "FirstName")?.Value;
    var userLastName = claims.FirstOrDefault(x => x.Type == "LastName")?.Value;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link href="~/css/index.css" rel="stylesheet" asp-append-version="true" />
    <style>
        .matched-row {
            background-color: #c9f7c1 !important; /* açık mavi ton */
            transition: background-color 0.3s ease !important;
        }

            .matched-row:hover {
                background-color: #b3f0aa !important; /* hover olduğunda biraz daha koyu */
            }

        .filter-bar {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

            .filter-bar input {
                padding: 6px 10px;
                border: 1px solid #ccc;
                border-radius: 6px;
            }

            .filter-bar button {
                padding: 6px 14px;
                border: none;
                border-radius: 6px;
                background: #444;
                color: white;
                cursor: pointer;
            }
    </style>
    <link rel="stylesheet" href="https://use.typekit.net/ovt6ynt.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,600;0,700;0,800;1,400;1,500;1,600;1,700;1,800&family=Oswald:wght@200;300;400;500;600;700&family=Roboto+Condensed:wght@300;400;700&family=Roboto:wght@100;300;400;500;700;900&family=Source+Sans+Pro:ital,wght@0,200;0,300;0,400;0,600;0,700;0,900;1,200;1,300;1,400;1,600;1,700;1,900&family=Spectral:wght@200;300;400;500;600;700;800&display=swap" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <title>DEM MUSEUMS</title>
</head>

<body>
    <div class="header">
        <div class="logo">
            <img id="logo" src="~/images/dem_logo.png" alt="Logo">
        </div>
        <div class="user-info">
            <p>
                @{
                    string CustomName = $"{userName} {userLastName}";
                }

                @CustomName
            </p>
        </div>
    </div>

    <div class="layout">
        @Html.Partial("~/Views/Shared/_sidebar.cshtml")
        <main class="table" id="demandTable">
            <section class="table__header">
                <h1>Fatura Listesi - Yeni</h1>

                <div class="filter-bar">
                    <input type="text" id="filterInvoiceNo" placeholder="Fatura No" />
                    <input type="text" id="filterSupplier" placeholder="Tedarikçi / Firma" />
                    <input type="text" id="filterVkn" placeholder="VKN / TCKN" />

                    <button onclick="clearFilters()">Temizle</button>
                    <button type="button"
                            class="excel-btn"
                            onclick="exportTableToExcel()">
                        <i class="fa fa-file-excel"></i> Excel’e Aktar
                    </button>

                </div>
            </section>

            <section class="content">
                <div id="content-0">
                    <section class="tableBody">
                        <table>
                            <thead>
                                <tr>
                                    <th data-type="string">Şirket <span class="icon-arrow">&UpArrow;</span></th>
                                    <th data-type="string">Fatura No <span class="icon-arrow">&UpArrow;</span></th>
                                    <th data-type="string">Firma <span class="icon-arrow">&UpArrow;</span></th>
                                    <th data-type="string">VKN/TCKN <span class="icon-arrow">&UpArrow;</span></th>
                                    <th data-type="string">Fatura Tipi <span class="icon-arrow">&UpArrow;</span></th>
                                    <th data-type="date">Fatura Tarihi <span class="icon-arrow">&UpArrow;</span></th>
                                    <th data-type="number">Fatura Tutarı <span class="icon-arrow">&UpArrow;</span></th>
                                    <th> Aksiyon </th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var invoice in Model.Where(x => x.InvoiceDetailEntity == null))
                                {
                                    <tr>
                                        <td data-label="Şirket">@invoice.CompanyName</td>
                                        <td data-label="Fatura No">@invoice.EInvoiceNumber</td>
                                        <td data-label="Firma">@invoice.CurrAccDescription</td>
                                        <td data-label="VKN/TCKN">@(string.IsNullOrWhiteSpace(invoice.TaxNumber) ? invoice.IdentityNum : invoice.TaxNumber)</td>
                                        <td class="action-buttons">
                                            <a href="javascript:void(0)" class="update-button" style="padding:2px 6px !important" onclick="invoiceTypeUpdatePopUp('@invoice.InvoiceHeaderID')" title="Fatura Tipi Güncelle">
                                                <i class="fa fa-edit"></i>
                                            </a>
                                        </td>
                                        <td data-label="Fatura Tarihi">@(invoice.InvoiceDate.ToString("yyyy-MM-dd"))</td>
                                        <td data-label="Fatura Tutarı">@(invoice.PayableAmount.ToString("N2") + " " + GetCurrencyIco(invoice.DocCurrencyCode))</td>
                                        <td class="action-buttons">
                                            <a href="https://portal.qnbesolutions.com.tr/efatura/display?cmd=GELEN_FATURA_GOSTER&type=html&invoiceUuid=@invoice.FromIntegratorUUID"
                                               target="_blank" title="Fatura Detayı">
                                                <i class="fa fa-file-invoice"></i>
                                            </a>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </section>
                </div>
            </section>

        </main>
        <div id="overlay"></div>

        <div id="invoiceTypePopup" class="popup" style="width: 30% !important;height: 41% !important;">
            <div class="popup-header">
                <h2>Fatura Tipi Güncelle</h2>
            </div>

            <div class="popup-content">

                <!-- Header Bilgileri -->
                <div class="form-row">
                    <div class="form-group" style="width:auto !important">
                        <label for="invoiceType">Fatura Tipi:</label>
                        <select id="invoiceType" name="invoiceType">
                            <option value="Please Select Invoice Type">Lütfen fatura tipi seçin...</option>
                            <option value="0">Toptan Alım</option>
                            <option value="1">Konsiye Alım</option>
                            <option value="2">Masraf Alımı</option>
                        </select>
                    </div>

                    <input type="hidden" id="invoiceTypePopupInvoiceId" value="" />
                    <div class="form-group" style="width:auto !important;align-items: anchor-center;">
                        <a href="javascript:void(0)" class="update-button" onclick="invoiceUpdate()">Güncelle ve Kontrole Gönder</a>

                    </div>
                </div>

            </div>
        </div>
        <div id="loadingOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; text-align:center; color:white; font-size:24px; line-height:100vh;">
            Yükleniyor...
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-ajax-unobtrusive/3.2.6/jquery.unobtrusive-ajax.min.js"></script>
    <script src="~/js/script.js"></script>
</body>

</html>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
    document.querySelectorAll("th[data-type]").forEach((th, index) => {
        let asc = true;

        th.addEventListener("click", () => {
            const table = th.closest("table");
            const tbody = table.querySelector("tbody");
            const rows = Array.from(tbody.querySelectorAll("tr"));
            const type = th.dataset.type;

            // Diğer okları resetle
            table.querySelectorAll(".icon-arrow").forEach(i => i.innerHTML = "&UpArrow;");

            rows.sort((a, b) => {
                let A = a.children[index].innerText.trim();
                let B = b.children[index].innerText.trim();

                if (type === "number") {
                    A = parseFloat(A.replace(/[^\d,-]/g, "").replace(",", ".")) || 0;
                    B = parseFloat(B.replace(/[^\d,-]/g, "").replace(",", ".")) || 0;
                }

                if (type === "date") {
                    A = new Date(A);
                    B = new Date(B);
                }

                if (A < B) return asc ? -1 : 1;
                if (A > B) return asc ? 1 : -1;
                return 0;
            });

            th.querySelector(".icon-arrow").innerHTML = asc ? "&DownArrow;" : "&UpArrow;";
            asc = !asc;

            tbody.append(...rows);
        });
    });
</script>

<script>
    function exportTableToExcel() {
        const table = document.querySelector("#demandTable table");
        if (!table) return;

        // Sadece görünen satırları export etmek için geçici bir tablo kopyası oluşturuyoruz
        const clonedTable = table.cloneNode(true);

        // Aksiyon kolonu (son kolon) export edilmesin istersen kaldır
        // (İstersen bu kısmı yorum satırı yapabilirsin)
        const headerRow = clonedTable.querySelector("thead tr");
        if (headerRow && headerRow.lastElementChild) headerRow.lastElementChild.remove();

        // Filtre sonrası gizlenen satırları kaldır
        const bodyRows = Array.from(clonedTable.querySelectorAll("tbody tr"));
        bodyRows.forEach(r => {
            // Orijinal tablodaki karşılığının display durumuna bak
            const index = bodyRows.indexOf(r);
            const originalRow = table.querySelectorAll("tbody tr")[index];
            const isHidden = originalRow && window.getComputedStyle(originalRow).display === "none";

            // Aksiyon kolonu kaldır
            if (r.lastElementChild) r.lastElementChild.remove();

            if (isHidden) r.remove();
        });

        // Excel'e çevir
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.table_to_sheet(clonedTable);
        XLSX.utils.book_append_sheet(wb, ws, "YeniFaturalar");

        const fileName = `Yeni_Faturalar_${new Date().toISOString().slice(0,10)}.xlsx`;
        XLSX.writeFile(wb, fileName);
    }
</script>
<script src="//cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"> </script>
<script>
    const invoiceInput = document.getElementById("filterInvoiceNo");
    const supplierInput = document.getElementById("filterSupplier");
    const vknInput = document.getElementById("filterVkn");

    const rows = document.querySelectorAll("tbody tr");

    function filterTable() {
        const invoiceVal = invoiceInput.value.toLowerCase();
        const supplierVal = supplierInput.value.toLowerCase();
        const vknVal = vknInput.value.toLowerCase();

        rows.forEach(row => {
            const invoiceNo = row.children[1].innerText.toLowerCase();
            const supplier = row.children[2].innerText.toLowerCase();
            const vkn = row.children[3].innerText.toLowerCase();

            const visible =
                invoiceNo.includes(invoiceVal) &&
                supplier.includes(supplierVal) &&
                vkn.includes(vknVal);

            row.style.display = visible ? "" : "none";
        });
    }

    invoiceInput.addEventListener("keyup", filterTable);
    supplierInput.addEventListener("keyup", filterTable);
    vknInput.addEventListener("keyup", filterTable);

    function clearFilters() {
        invoiceInput.value = "";
        supplierInput.value = "";
        vknInput.value = "";
        filterTable();
    }
</script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const toggles = document.querySelectorAll(".submenu-toggle");
        toggles.forEach(toggle => {
            toggle.addEventListener("click", function () {
                const submenu = this.nextElementSibling;
                submenu.classList.toggle("open");
            });
        });
    });

    function formatPrice(value) {
        if (value == null || value === "") return "";
        return Number(value).toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function formatDate(dateString) {
        if (!dateString) return "";
        const date = new Date(dateString);
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}.${month}.${year}`;
    }

    document.addEventListener('keydown', function (event) {
        if (event.key === 'Escape') {
            closePopup("invoiceTypePopup");
        }
    });

    function invoiceTypeUpdatePopUp(invoiceHeaderId){
        openPopup("invoiceTypePopup");

        $("#invoiceTypePopupInvoiceId").val(invoiceHeaderId);
    }

    function invoiceUpdate() {
        var invoiceId = $("#invoiceTypePopupInvoiceId").val();
        var invoiceType = $("#invoiceType").val();

        var data = {
            id: invoiceId,
            invoiceType: parseInt(invoiceType),
        };

        $.ajax({
            url: '/Invoice/InvoiceUpdate',
            type: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function (response) {
                toastr.success(`Fatura Bilgileri Güncellenmiştir.`, "Başarılı");
                location.reload();
            },
            error: function (xhr, status, error) {
                toastr.error(`Bir hata oluştu, lütfen tekrar deneyin.`, "Hata");
            }
        });
    }

    $(document).on('change', '.chk-select', function () {
        var row = $(this).closest('tr');
        if ($(this).is(':checked')) {
            row.addClass('matched-row');
        } else {
            row.removeClass('matched-row');
        }
    });


    function openPopup(popupId) {
        var overlay = document.getElementById("overlay");
        var popup = document.getElementById(popupId);

        if (overlay && popup) {
            overlay.style.display = "block";
            popup.style.display = "block";

            popup.style.width = "80%";
            popup.style.height = "90%";

            overlay.addEventListener("click", function () {
                closePopup(popupId);
            });
        }
    }

    function closePopup(popupId) {
        var overlay = document.getElementById("overlay");
        var popup = document.getElementById(popupId);

        if (overlay && popup) {
            overlay.style.display = "none";
            popup.style.display = "none";
            overlay.removeEventListener("click", function () {
                closePopup(popupId);
            });
        }
    }
</script>

@functions {
    string GetInvoiceType(int type)
    {
        switch (type)
        {
            case 0: return "Toptan Alım";
            case 1: return "Konsiye Alım";
            case 2: return "Masraf Alım";
            default: return type.ToString();
        }
    }

    string GetCurrencyIco(string currencyCode)
    {
        switch (currencyCode)
        {
            case "TRY": return "₺";
            case "USD": return "$";
            case "EUR": return "€";
            case "GBP": return "£";
            default: return currencyCode;
        }
    }
}