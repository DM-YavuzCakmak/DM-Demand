@using Demand.Domain.Enums
@using Demand.Domain.NebimModels
@using System.Security.Claims
@using System.Text.Json
@model List<IncomingEInvoiceHeaderModel>

@{
    var claimsIdentity = (ClaimsIdentity)User.Identity;
    var claims = claimsIdentity.Claims;
    var userId = long.Parse(claims.FirstOrDefault(x => x.Type == "UserId").Value);
    var isViewNewInvoice = bool.Parse(claims.FirstOrDefault(x => x.Type == "IsViewNewInvoice").Value);
    var IsViewControlInvoice = bool.Parse(claims.FirstOrDefault(x => x.Type == "IsViewControlInvoice").Value);
    var userName = claims.FirstOrDefault(x => x.Type == "FirstName")?.Value;
    var userLastName = claims.FirstOrDefault(x => x.Type == "LastName")?.Value;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link href="~/css/index.css" rel="stylesheet" asp-append-version="true" />
    <style>
        .matched-row {
            background-color: #c9f7c1 !important; /* açık mavi ton */
            transition: background-color 0.3s ease !important;
        }

            .matched-row:hover {
                background-color: #b3f0aa !important; /* hover olduğunda biraz daha koyu */
            }

        .filter-bar {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

            .filter-bar input {
                padding: 6px 10px;
                border: 1px solid #ccc;
                border-radius: 6px;
            }

            .filter-bar button {
                padding: 6px 14px;
                border: none;
                border-radius: 6px;
                background: #444;
                color: white;
                cursor: pointer;
            }

    </style>
    <link rel="stylesheet" href="https://use.typekit.net/ovt6ynt.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,600;0,700;0,800;1,400;1,500;1,600;1,700;1,800&family=Oswald:wght@200;300;400;500;600;700&family=Roboto+Condensed:wght@300;400;700&family=Roboto:wght@100;300;400;500;700;900&family=Source+Sans+Pro:ital,wght@0,200;0,300;0,400;0,600;0,700;0,900;1,200;1,300;1,400;1,600;1,700;1,900&family=Spectral:wght@200;300;400;500;600;700;800&display=swap" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <title>DEM MUSEUMS</title>
</head>

<body>
    <div class="header">
        <div class="logo">
            <img id="logo" src="~/images/dem_logo.png" alt="Logo">
        </div>
        <div class="user-info">
            <p>
                @{
                    string CustomName = $"{userName} {userLastName}";
                }

                @CustomName
            </p>
        </div>
    </div>

    <div class="layout">
        @Html.Partial("~/Views/Shared/_sidebar.cshtml")
        <main class="table" id="demandTable">
            <section class="table__header">
                <h1>Fatura Listesi - Reddedilen</h1>

                <div class="filter-bar">
                    <input type="text" id="filterInvoiceNo" placeholder="Fatura No" />
                    <input type="text" id="filterSupplier" placeholder="Tedarikçi / Firma" />
                    <input type="text" id="filterVkn" placeholder="VKN / TCKN" />

                    <button onclick="clearFilters()">Temizle</button>
                    <button type="button"
                            class="excel-btn"
                            onclick="exportTableToExcel()">
                        <i class="fa fa-file-excel"></i> Excel’e Aktar
                    </button>

                </div>
            </section>

            <section class="content">
                <div id="content-3">
                    <section class="tableBody">
                        <table>
                            <thead>
                                <tr>
                                    <th data-type="string"> Şirket <span class="icon-arrow">&UpArrow;</span></th>
                                    <th data-type="string"> Fatura No <span class="icon-arrow">&UpArrow;</span></th>
                                    <th data-type="string"> Şirket Bilgisi <span class="icon-arrow">&UpArrow;</span></th>
                                    <th data-type="string"> VKN/TCKN <span class="icon-arrow">&UpArrow;</span></th>
                                    <th data-type="date"> Fatura Tarihi <span class="icon-arrow">&UpArrow;</span></th>
                                    <th data-type="number"> Fatura Tutarı <span class="icon-arrow">&UpArrow;</span></th>
                                    <th data-type="string"> Departman <span class="icon-arrow">&UpArrow;</span></th>
                                    <th data-type="string"> Red Eden <span class="icon-arrow">&UpArrow;</span></th>
                                    <th data-type="date"> Red Tarihi <span class="icon-arrow">&UpArrow;</span></th>
                                    <th data-type="string"> Red Açıklama <span class="icon-arrow">&UpArrow;</span></th>
                                    <th> Aksiyon </th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var invoice in Model.Where(x => x.IsViewInvoicePrivilege))
                                {
                                    <tr>
                                        <td data-label="Şirket">@invoice.CompanyName</td>
                                        <td data-label="Fatura No">@invoice.EInvoiceNumber</td>
                                        <td data-label="Firma">@invoice.CurrAccDescription</td>
                                        <td data-label="VKN/TCKN">@(string.IsNullOrWhiteSpace(invoice.TaxNumber) ? invoice.IdentityNum : invoice.TaxNumber)</td>
                                        <td data-label="Fatura Tipi">@(GetInvoiceType(invoice.InvoiceDetailEntity.InvoiceType))</td>
                                        <td data-label="Fatura Tarihi">@(invoice.InvoiceDate.ToString("yyyy-MM-dd"))</td>
                                        <td data-label="Fatura Tutarı">@(invoice.PayableAmount.ToString("N2") + " " + GetCurrencyIco(invoice.DocCurrencyCode))</td>
                                        <td data-label="Departman">@(invoice.InvoiceDetailEntity.SentToDepartment != null ? invoice.InvoiceDetailEntity.SentToDepartment.Name : "")</td>
                                        <td data-label="Red Eden">@(invoice.InvoiceDetailEntity.UpdatedBy != null ? invoice.InvoiceDetailEntity.UpdatedBy.FirstName + " " + invoice.InvoiceDetailEntity.UpdatedBy.LastName : "")</td>
                                        <td data-label="Red Tarihi">@(invoice.InvoiceDetailEntity.ReturnDate != null ? invoice.InvoiceDetailEntity.ReturnDate : "")</td>
                                        <td data-label="Red Açıklama">@(invoice.InvoiceDetailEntity.RejectionNote)</td>
                                        <td class="action-buttons">
                                            @if (invoice.IsChangeStatusPrivilege)
                                            {
                                                <a href="javascript:void(0)" onclick="invoiceApprovedUpdatePopUp('@invoice.InvoiceHeaderID')" title="Onaya Gönder">
                                                    <i class="fa fa-paper-plane"></i>
                                                </a>
                                                <a href="javascript:void(0)" onclick="invoiceDetailPopup('@invoice.InvoiceHeaderID')" title="Görüntüle">
                                                    <i class="fa fa-search"></i>
                                                </a>
                                            }
                                            <a href="https://portal.qnbesolutions.com.tr/efatura/display?cmd=GELEN_FATURA_GOSTER&type=html&invoiceUuid=@invoice.FromIntegratorUUID"
                                               target="_blank" title="Fatura Detayı">
                                                <i class="fa fa-file-invoice"></i>
                                            </a>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </section>
                </div>
            </section>

        </main>
        <div id="overlay"></div>

        <div id="invoiceDetailPopup" class="popup">
            <div class="popup-header">
                <h2>Fatura Detayı</h2>
            </div>

            <div class="popup-content" style="overflow-y: auto !important;">

                <!-- Header Bilgileri -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="company">Şirket</label>
                        <input type="text" id="company" readonly />
                    </div>
                    <div class="form-group">
                        <label for="provider">Firma</label>
                        <input type="text" id="provider" readonly />
                    </div>
                    <div class="form-group">
                        <label for="taxnumber">VKN/TCKN</label>
                        <input type="text" id="taxnumber" readonly />
                    </div>
                </div>

                <!-- Header Bilgileri -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="invoiceNo">Fatura No</label>
                        <input type="text" id="invoiceNo" readonly />
                    </div>
                    <div class="form-group">
                        <label for="requestDate">Fatura Tarihi</label>
                        <input type="text" id="requestDate" readonly />
                    </div>
                    <div class="form-group">
                        <label for="payableAmount">Toplam Tutar</label>
                        <input type="text" id="payableAmount" readonly />
                    </div>
                </div>

                <!-- Açıklama -->
                @* <div class="form-group" style="width:auto !important">
					<label for="description">Açıklama</label>
					<textarea id="description" readonly></textarea>
				</div> *@

                <input type="hidden" id="invoiceDetailPopupInvoiceId" value="" />

                <!-- Fatura Kalemleri -->
                <h3 style="margin: 10px;">Fatura Kalemleri</h3>
                <div style="max-height: 250px; overflow-y: auto; border: 1px solid #ccc;">
                    <table id="dataTableInvoiceDetail" border="1" style="width:100%; border-collapse: collapse;">
                        <thead style="position: sticky; top: 0; background-color: #f9f9f9;">
                        <thead>
                            <tr>
                                <th>Adı</th>
                                <th>Adet</th>
                                @* <th>İndirim Oranı</th>
								<th>İndirim Tutarı</th> *@
                                <th>KDV Oranı</th>
                                <th>KDV Tutarı</th>
                                <th>Toplam Tutar</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- JS ile doldurulacak -->
                        </tbody>
                    </table>
                </div>

                <!-- Satın Alma Talepleri -->
                <h3 style="margin: 10px;">Eşleştirilen Satın Alma Talepleri</h3>
                <div style="max-height: 250px; overflow-y: auto; border: 1px solid #ccc;">
                    <table id="dataTable" border="1" style="width:100%; border-collapse: collapse;">
                        <thead style="position: sticky; top: 0; background-color: #f9f9f9;">
                        <thead>
                            <tr>
                                <th>Id</th>
                                <th>Başlık</th>
                                <th>Departman</th>
                                <th>Kur</th>
                                <th>Toplam Tutar</th>
                                <th>Kalan Tutar</th>
                                <th>Eşleşen Tutar</th>
                                <th>Aksiyon</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- JS ile doldurulacak -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div id="invoiceApprovedUpdatePopup" class="popup">
            <div class="popup-header">
                <h2>Faturayı Onaya Gönder</h2>
            </div>

            <div class="popup-content">

                <!-- Header Bilgileri -->
                <div class="form-row">
                    <div class="form-group" style="width:auto !important">
                        <label for="approvedDepartmentId">Onay Verecek Departman:</label>
                        <select id="approvedDepartmentId" name="approvedDepartmentId">
                            <option value="Please Select Responsible Department">Lütfen departman seçin...</option>
                            @foreach (var department in ViewBag.DepartmentList)
                            {
                                <option value="@department.Id">@(department.Name)</option>
                            }
                        </select>
                    </div>
                    <div class="form-group" style="width:auto !important">
                        <label for="approvedUserId">İlk Onay Verecek Kullanıcı:</label>
                        <select id="approvedUserId" name="approvedUserId">
                            <option value="Please Select Responsible User">Lütfen kullanıcı seçin...</option>
                        </select>
                    </div>
                    <div class="form-group" style="width:auto !important">
                        <label for="approvedManagerId">Onay Verecek Yönetici:</label>
                        <select id="approvedManagerId" name="approvedManagerId">
                            <option value="Please Select Responsible Manager">Lütfen yönetici seçin...</option>
                        </select>
                    </div>
                    <input type="hidden" id="invoiceApprovedUpdatePopupInvoiceId" value="" />
                </div>
                <div class="form-group" style="width:auto !important;margin-top:10px; display:flex; justify-content:center;">
                    <a href="javascript:void(0)" class="update-button" onclick="invoiceApprovedUpdate()">Onaya Gönder</a>
                </div>
            </div>
        </div>

        <div id="loadingOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; text-align:center; color:white; font-size:24px; line-height:100vh;">
            Yükleniyor...
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-ajax-unobtrusive/3.2.6/jquery.unobtrusive-ajax.min.js"></script>
    <script src="~/js/script.js"></script>

</body>

</html>

<script src="//cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"> </script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
    document.querySelectorAll("th[data-type]").forEach((th, index) => {
        let asc = true;

        th.addEventListener("click", () => {
            const table = th.closest("table");
            const tbody = table.querySelector("tbody");
            const rows = Array.from(tbody.querySelectorAll("tr"));
            const type = th.dataset.type;

            // Diğer okları resetle
            table.querySelectorAll(".icon-arrow").forEach(i => i.innerHTML = "&UpArrow;");

            rows.sort((a, b) => {
                let A = a.children[index].innerText.trim();
                let B = b.children[index].innerText.trim();

                if (type === "number") {
                    A = parseFloat(A.replace(/[^\d,-]/g, "").replace(",", ".")) || 0;
                    B = parseFloat(B.replace(/[^\d,-]/g, "").replace(",", ".")) || 0;
                }

                if (type === "date") {
                    A = new Date(A);
                    B = new Date(B);
                }

                if (A < B) return asc ? -1 : 1;
                if (A > B) return asc ? 1 : -1;
                return 0;
            });

            th.querySelector(".icon-arrow").innerHTML = asc ? "&DownArrow;" : "&UpArrow;";
            asc = !asc;

            tbody.append(...rows);
        });
    });
</script>

<script>
    function exportTableToExcel() {
        const table = document.querySelector("#demandTable table");
        if (!table) return;

        // Sadece görünen satırları export etmek için geçici bir tablo kopyası oluşturuyoruz
        const clonedTable = table.cloneNode(true);

        // Aksiyon kolonu (son kolon) export edilmesin istersen kaldır
        // (İstersen bu kısmı yorum satırı yapabilirsin)
        const headerRow = clonedTable.querySelector("thead tr");
        if (headerRow && headerRow.lastElementChild) headerRow.lastElementChild.remove();

        // Filtre sonrası gizlenen satırları kaldır
        const bodyRows = Array.from(clonedTable.querySelectorAll("tbody tr"));
        bodyRows.forEach(r => {
            // Orijinal tablodaki karşılığının display durumuna bak
            const index = bodyRows.indexOf(r);
            const originalRow = table.querySelectorAll("tbody tr")[index];
            const isHidden = originalRow && window.getComputedStyle(originalRow).display === "none";

            // Aksiyon kolonu kaldır
            if (r.lastElementChild) r.lastElementChild.remove();

            if (isHidden) r.remove();
        });

        // Excel'e çevir
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.table_to_sheet(clonedTable);
        XLSX.utils.book_append_sheet(wb, ws, "ReddedilenFaturalar");

        const fileName = `Reddedilen_Faturalar_${new Date().toISOString().slice(0,10)}.xlsx`;
        XLSX.writeFile(wb, fileName);
    }
</script>

<script>
    const invoiceInput = document.getElementById("filterInvoiceNo");
    const supplierInput = document.getElementById("filterSupplier");
    const vknInput = document.getElementById("filterVkn");

    const rows = document.querySelectorAll("tbody tr");

    function filterTable() {
        const invoiceVal = invoiceInput.value.toLowerCase();
        const supplierVal = supplierInput.value.toLowerCase();
        const vknVal = vknInput.value.toLowerCase();

        rows.forEach(row => {
            const invoiceNo = row.children[1].innerText.toLowerCase();
            const supplier = row.children[2].innerText.toLowerCase();
            const vkn = row.children[3].innerText.toLowerCase();

            const visible =
                invoiceNo.includes(invoiceVal) &&
                supplier.includes(supplierVal) &&
                vkn.includes(vknVal);

            row.style.display = visible ? "" : "none";
        });
    }

    invoiceInput.addEventListener("keyup", filterTable);
    supplierInput.addEventListener("keyup", filterTable);
    vknInput.addEventListener("keyup", filterTable);

    function clearFilters() {
        invoiceInput.value = "";
        supplierInput.value = "";
        vknInput.value = "";
        filterTable();
    }
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const toggles = document.querySelectorAll(".submenu-toggle");
        toggles.forEach(toggle => {
            toggle.addEventListener("click", function () {
                const submenu = this.nextElementSibling;
                submenu.classList.toggle("open");
            });
        });
    });

    function reset($el, text) {
        $el.empty().append($("<option/>").val("").text(text));
    }

    function getId(x) { return x.id || x.Id; }
    function getText(x) { return x.text || x.Text; }
    function getIsFirstCheck(x) { return x.isFirstCheck === true || x.IsFirstCheck === true; }

    $("#approvedDepartmentId").on("change", function () {
        const departmentId = $(this).val();

        const $user = $("#approvedUserId");
        const $manager = $("#approvedManagerId");

        reset($user, "Lütfen kullanıcı seçin...");
        reset($manager, "Lütfen yönetici seçin...");

        if (!departmentId) return;

        $.getJSON("/Invoice/GetUsersByDepartment", { departmentId: departmentId })
            .done(function (data) {
                const users = data.users || data.Users || [];
                const managers = data.managers || data.Managers || [];

                // --- USERS doldur ---
                users.forEach(function (u) {
                    $user.append($("<option/>").val(getId(u)).text(getText(u)));
                });

                // Kullanıcı auto-select:
                // 1) isFirstCheck true olan varsa onu seç
                // 2) yoksa tek kullanıcı geldiyse onu seç
                const firstCheckUser = users.find(getIsFirstCheck);
                if (firstCheckUser) {
                    $user.val(String(getId(firstCheckUser)));
                } else if (users.length === 1) {
                    $user.val(String(getId(users[0])));
                }

                // --- MANAGERS doldur ---
                managers.forEach(function (m) {
                    $manager.append($("<option/>").val(getId(m)).text(getText(m)));
                });

                // Yönetici auto-select: tek yönetici geldiyse
                if (managers.length === 1) {
                    $manager.val(String(getId(managers[0])));
                }
            })
            .fail(function () {
                alert("Departmana bağlı kullanıcılar alınırken hata oluştu.");
            });
    });

    function formatPrice(value) {
        if (value == null || value === "") return "";
        return Number(value).toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function formatDate(dateString) {
        if (!dateString) return "";
        const date = new Date(dateString);
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}.${month}.${year}`;
    }

    document.addEventListener('keydown', function (event) {
        if (event.key === 'Escape') {
            closePopup("invoiceDetailPopup");
            closePopup("invoiceTypePopup");
            closePopup("invoiceApprovedUpdatePopup");
            closePopup("invoiceRejectionPopup");
        }
    });

    function invoiceTypeUpdatePopUp(invoiceHeaderId){
        openPopup("invoiceTypePopup");

        $("#invoiceTypePopupInvoiceId").val(invoiceHeaderId);
    }

    function invoiceApprovedUpdatePopUp(invoiceHeaderId){
        openPopup("invoiceApprovedUpdatePopup");

        $("#invoiceApprovedUpdatePopupInvoiceId").val(invoiceHeaderId);
    }

    function invoiceRejection2(){
        closePopup("invoiceDetailPopup");

        var invoiceId = $("#invoiceDetailPopupInvoiceId").val();
        invoiceRejectionPopUp(invoiceId);
    }

    function invoiceRejectionPopUp(invoiceHeaderId){
        openPopup("invoiceRejectionPopup");

        $("#invoiceRejectionPopupInvoiceId").val(invoiceHeaderId);
    }

     function invoiceUpdate() {
        var invoiceId = $("#invoiceTypePopupInvoiceId").val();
        var invoiceType = $("#invoiceType").val();
        var responsiblePersonId = $("#responsiblePersonId").val();

        var data = {
            id: invoiceId,
            invoiceType: parseInt(invoiceType),
            responsiblePersonId: parseInt(responsiblePersonId)
        };

        $.ajax({
            url: '/Invoice/InvoiceUpdate',
            type: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function (response) {
                toastr.success(`Fatura Bilgileri Güncellenmiştir.`, "Başarılı");
                location.reload();
            },
            error: function (xhr, status, error) {
                toastr.error(`Bir hata oluştu, lütfen tekrar deneyin.`, "Hata");
            }
        });
    }

     function invoiceApprovedUpdate() {
        var invoiceId = $("#invoiceApprovedUpdatePopupInvoiceId").val();
        var approvedDepartmentId = $("#approvedDepartmentId").val();
        var approvedManagerId = $("#approvedManagerId").val();
        var approvedUserId = $("#approvedUserId").val();

        var data = {
            id: invoiceId,
            approvedDepartmentId: parseInt(approvedDepartmentId),
            approvedManagerId: parseInt(approvedManagerId),
            approvedUserId: parseInt(approvedUserId)
        };

        $.ajax({
            url: '/Invoice/InvoiceApprovedUpdate',
            type: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function (response) {
                toastr.success(`Fatura Onaya Gönderilmiştir.`, "Başarılı");
                location.reload();
            },
            error: function (xhr, status, error) {
                toastr.error(`Bir hata oluştu, lütfen tekrar deneyin.`, "Hata");
            }
        });
    }

     function invoiceRejection() {
        Swal.fire({
            title: "Emin misiniz?",
            text: "Bu faturayı onaylamak istediğinize emin misiniz?",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Evet, onayla",
            cancelButtonText: "Vazgeç",
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#d33"
        }).then((result) => {
            if (result.isConfirmed) {
                var invoiceId = $("#invoiceRejectionPopupInvoiceId").val();
                var rejectionDesc = $("#rejectionDesc").val();

                var data = {
                    id: invoiceId,
                    rejectionDesc: rejectionDesc
                };

                $.ajax({
                    url: '/Invoice/InvoiceRejection',
                    type: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify(data),
                    success: function (response) {
                        toastr.success(`Fatura Ret Edilmiştir.`, "Başarılı");
                        location.reload();
                    },
                    error: function (xhr, status, error) {
                        toastr.error(`Bir hata oluştu, lütfen tekrar deneyin.`, "Hata");
                    }
                });
            }
        });
    }

    function invoiceApproved2(){
        closePopup("invoiceDetailPopup");

        var invoiceId = $("#invoiceDetailPopupInvoiceId").val();
        invoiceApproved(invoiceId);
    }

    function invoiceApproved(invoiceHeaderId) {
        Swal.fire({
            title: "Emin misiniz?",
            text: "Bu faturayı onaylamak istediğinize emin misiniz?",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Evet, onayla",
            cancelButtonText: "Vazgeç",
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#d33"
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: '/Invoice/InvoiceApproved',
                    type: 'GET',
                    data: { invoiceHeaderId: invoiceHeaderId },
                    success: function (response) {
                        toastr.success(`Fatura Onaylanmıştır.`, "Başarılı");
                        location.reload();
                    },
                    error: function (xhr, status, error) {
                        toastr.error(`Bir hata oluştu, lütfen tekrar deneyin.`, "Hata");
                    }
                });
            }
        });
    }

    $(document).on('change', '.chk-select', function () {
        var row = $(this).closest('tr');
        if ($(this).is(':checked')) {
            row.addClass('matched-row');
        } else {
            row.removeClass('matched-row');
        }
    });

    function invoiceDetailPopup(invoiceHeaderId) {
        $("#invoiceDetailPopupInvoiceId").val(invoiceHeaderId);

        $.ajax({
            url: '/Invoice/GetInvoiceDemands',
            type: 'GET',
            data: { invoiceHeaderId: invoiceHeaderId, isApproved: true },
            success: function (data) {
                // Header bilgilerini doldur
                $("#invoiceNo").val(data.invoice.eInvoiceNumber);
                $("#requestDate").val(formatDate(data.invoice.invoiceDate));
                // $("#description").val(data.invoice.description);
                $("#payableAmount").val(formatPrice(data.invoice.payableAmount) + " " + data.invoice.docCurrencyCode);

                $("#company").val(data.invoice.companyName);
                $("#provider").val(data.invoice.currAccDescription);
                $("#taxnumber").val(data.invoice.taxNumber);// IdentityNum

                // Line bilgilerini tabloya bas
                var tableInvoiceDetail = $("#dataTableInvoiceDetail tbody");
                tableInvoiceDetail.empty();

                if (!data.invoiceDetails || data.invoiceDetails.length === 0) {
                    // ⚠️ Eğer kayıt yoksa uyarı satırı ekle
                    tableInvoiceDetail.append(`
                        <tr>
                            <td colspan="10" style="text-align:center; color:#666; padding:10px;">
                                Fatura Detayları Bulunmamaktadır
                            </td>
                        </tr>
                    `);
                } else {
                    $.each(data.invoiceDetails, function (i, line) {
                        tableInvoiceDetail.append(`
                            <tr>
                                <td data-label="Adı">${line.itemName}</td>
                                <td data-label="Adet">${line.qty1}</td>
                                <td data-label="KDV Oranı">${line.vatRate}</td>
                                <td data-label="KDV Tutarı">${line.vat}</td>
                                <td data-label="Toplam Tutar">${line.netAmount} ${line.priceCurrencyCode}</td>
                            </tr>
                        `);
                                // <td>${line.lDisRate1}</td>
                                // <td>${line.lDiscount1}</td>
                    });
                }

                // Line bilgilerini tabloya bas
                var table = $("#dataTable tbody");
                table.empty();

                if (!data.demands || data.demands.length === 0) {
                    // ⚠️ Eğer kayıt yoksa uyarı satırı ekle
                    table.append(`
                        <tr>
                            <td colspan="10" style="text-align:center; color:#666; padding:10px;">
                                VKN/TCKN ait Satın Alma Talebi Bulunamamıştır.
                            </td>
                        </tr>
                    `);

                } else {
                    $.each(data.demands, function (i, line) {
                        // matchingPrice dolu mu kontrol et
                        var isMatched = line.matchingPrice != null && line.matchingPrice !== "";
                        var checkboxChecked = isMatched ? "checked" : "";
                        var inputValue = isMatched ? line.matchingPrice : line.remainingPrice;
                        var rowClass = isMatched ? "matched-row" : "";

                        table.append(`
                            <tr
                                data-total="${line.remainingPrice}"
                                data-id="${line.demandId}"
                                data-invoicetotal="${data.invoice.payableAmount}"
                                data-currency="${line.currencySymbol}">

                                <td data-label="Id">${line.demandId}</td>
                                <td data-label="Başlık">${line.demandTitle}</td>
                                <td data-label="Departman">${line.departmentName}</td>
                                <td data-label="Kur">${formatPrice(line.exchangeRate)}</td>
                                <td data-label="Toplam Tutar">${formatPrice(line.totalPrice)} ${line.currencySymbol}</td>
                                <td data-label="Kalan Tutar">${formatPrice(line.remainingPrice)} ${line.currencySymbol}</td>
                                <td data-label="Eşleşen Tutar">${formatPrice(inputValue)} ${line.currencySymbol}</td>
                                <td data-label="Aksiyon">
                                    <a target="_blank"
                                       href="../api/Demands/DemandOfferDetail?DemandId=${line.demandId}"
                                       style="text-align: center;display: inline-block;font-weight: bold;">
                                       Teklif Detayı
                                    </a>
                                </td>
                            </tr>
                        `);
                    });
                }

                // Popup aç
                openPopup("invoiceDetailPopup");
            }
        });
    }

        // Eşle butonuna tıklanınca
    function SaveInvoceDemand() {
        var selectedItems = [];
        var hasError = false; // ⚠️ Hata durumunu takip edecek bayrak
        var invoiceId = $("#invoiceDetailPopupInvoiceId").val();
        var selectedInvoiceTotal = 0;

        $("#dataTable tbody tr").each(function () {
            debugger;
            var checkbox = $(this).find(".chk-select");
            if (checkbox.is(":checked")) {
                var demandId = $(this).data("id");
                var currencySymbol = $(this).data("currency");
                var total = parseFloat($(this).data("total"));
                var invoiceTotal = parseFloat($(this).data("invoicetotal"));
                var tutar = parseFloat($(this).find(".txt-tutar").val());

                if (isNaN(tutar) || tutar <= 0) {
                    toastr.error(`Lütfen geçerli bir tutar giriniz.`, "Hata");
                    hasError = true;
                    return false;
                }

                if (tutar > total) {
                    toastr.error(`Girilen tutar (${formatPrice(tutar)} ${currencySymbol}), satırın kalan tutarını (${formatPrice(total)} ${currencySymbol}) aşamaz!`, "Hata");
                    hasError = true;
                    return false;
                }

                selectedInvoiceTotal += tutar;
                if (selectedInvoiceTotal > invoiceTotal) {
                    toastr.error(`Girilen tutarların toplamı (${formatPrice(selectedInvoiceTotal)} ${currencySymbol}), fatura tutarını (${formatPrice(invoiceTotal)} ${currencySymbol}) aşamaz!`, "Hata");
                    hasError = true;
                    return false;
                }

                selectedItems.push({
                    invoiceId: invoiceId,
                    demandId: demandId,
                    amount: tutar
                });
            }
        });
        debugger;

        if (hasError) {
            return; // ❌ Hata varsa işlem tamamen durur
        }

        if (selectedItems.length === 0) {
            toastr.error(`Lütfen en az bir satır seçin.`, "Hata");
            return;
        }

        // AJAX POST isteği
        $.ajax({
            url: '/Invoice/SaveInvoiceDemand',
            type: 'PUT',
            data: JSON.stringify(selectedItems),
            contentType: 'application/json',
            success: function (res) {
                toastr.success(`Eşleştirme işlemi başarılı!`, "Başarılı");
                closePopup("invoiceDetailPopup");
            },
            error: function (err) {
                console.error(err);
                toastr.error(`Bir hata oluştu, lütfen tekrar deneyin.`, "Hata");
            }
        });
    }



    function openPopup(popupId) {
        var overlay = document.getElementById("overlay");
        var popup = document.getElementById(popupId);

        if (overlay && popup) {
            overlay.style.display = "block";
            popup.style.display = "block";

            popup.style.width = "80%";
            popup.style.height = "90%";

            overlay.addEventListener("click", function () {
                closePopup(popupId);
            });
        }
    }

    function closePopup(popupId) {
        var overlay = document.getElementById("overlay");
        var popup = document.getElementById(popupId);

        if (overlay && popup) {
            overlay.style.display = "none";
            popup.style.display = "none";
            overlay.removeEventListener("click", function () {
                closePopup(popupId);
            });
        }
    }
</script>

@functions {
    string GetInvoiceType(int type)
    {
        switch (type)
        {
            case 0: return "Toptan Alım";
            case 1: return "Konsiye Alım";
            case 2: return "Masraf Alım";
            default: return type.ToString();
        }
    }

    string GetCurrencyIco(string currencyCode)
    {
        switch (currencyCode)
        {
            case "TRY": return "₺";
            case "USD": return "$";
            case "EUR": return "€";
            case "GBP": return "£";
            default: return currencyCode;
        }
    }
}